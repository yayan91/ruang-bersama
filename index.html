<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUANG BERSAMA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f2f4f8; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        .mobile-container { max-width: 480px; margin: 0 auto; background: #fff; min-height: 100vh; position: relative; box-shadow: 0 0 25px rgba(0,0,0,0.05); overflow-x: hidden; display: flex; flex-direction: column; }
        .screen { display: none; padding: 20px; animation: slideUp 0.3s; flex-grow: 1; }
        .active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        .popup-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .popup-content { background: white; width: 80%; max-width: 320px; border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .app-header-date { background: #fff; padding: 15px 20px 5px 20px; font-weight: bold; color: #555; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .profile-header { display: flex; align-items: center; margin-bottom: 20px; margin-top: 10px; }
        .profile-info { flex-grow: 1; }
        .profile-img-lg { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; border: 3px solid #0d6efd; margin-left: 15px; background: #eee; cursor: pointer; }
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; margin-bottom: 30px; }
        .menu-item { background: #fff; border: 1px solid #f0f0f0; border-radius: 15px; height: 95px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .menu-item:active { transform: scale(0.95); background: #f8f9fa; }
        .menu-item i { font-size: 24px; margin-bottom: 8px; }
        .menu-item span { font-size: 10px; font-weight: 700; color: #555; }
        .app-footer { background: #f8f9fa; padding: 15px; text-align: center; border-top: 1px solid #eee; margin-top: auto; }
        .app-footer h6 { font-size: 12px; font-weight: bold; margin: 0; color: #0d6efd; }
        .app-footer small { font-size: 10px; color: #888; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .card-custom { border:none; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.03); margin-bottom:10px; }
        .chat-bubble { padding: 10px 15px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 12px; }
        .chat-me { background: #d1e7dd; align-self: flex-end; margin-left: auto; }
        .chat-other { background: #f8f9fa; align-self: flex-start; margin-right: auto; }
        .mood-icon { font-size: 30px; cursor: pointer; transition: 0.2s; }
        .mood-icon:hover, .mood-selected { transform: scale(1.3); }
        .dev-card { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #0d6efd, #0043a8); color: white; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(13, 110, 253, 0.3); }
        .dev-img { width: 100px; height: 100px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); margin-bottom: 15px; object-fit: cover; }
    </style>
</head>
<body>

<div class="mobile-container">
    <div id="loader" class="loading-overlay"><div class="spinner-border text-primary"></div><p class="mt-2 fw-bold text-primary small">Memproses...</p></div>
    <div id="custom-popup" class="popup-overlay"><div class="popup-content"><div id="popup-icon" class="mb-3 text-primary" style="font-size: 50px;"></div><h5 id="popup-title" class="fw-bold mb-2">Title</h5><p id="popup-msg" class="text-muted small mb-4">Msg</p><button id="popup-btn" class="btn btn-primary w-100 rounded-pill fw-bold shadow">OK</button></div></div>
    
    <div class="app-header-date"><span id="headerDate">...</span></div>

    <div id="screen-login" class="screen active">
        <div class="text-center" style="margin-top: 50px; margin-bottom: 30px;">
            <div style="width: 70px; height: 70px; background: #0d6efd; border-radius: 18px; margin: 0 auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px;"><i class="fas fa-users"></i></div>
            <h4 class="fw-bold mt-3 text-dark">RUANG BERSAMA</h4>
            <p class="text-muted small mb-1">Sistem Informasi Sekolah Terpadu</p>
            <div class="mt-4 p-3 bg-light rounded-3 border shadow-sm"><h6 class="fw-bold text-primary m-0">RUANG KITA</h6><h6 class="fw-bold text-primary m-0">KARYA KITA</h6><small class="text-warning fw-bold d-block mt-1">SEJUTA INSPIRASI</small></div>
        </div>
        <form id="formLogin">
            <div class="form-floating mb-3"><input type="text" class="form-control" id="uName" required><label>Username</label></div>
            <div class="form-floating mb-4"><input type="password" class="form-control" id="uPass" required><label>Password</label></div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-sm">MASUK APLIKASI</button>
        </form>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="profile-header">
            <div class="profile-info"><h5 class="fw-bold m-0 text-dark" id="dashNama">User</h5><span class="badge bg-primary" id="dashRole">Role</span><small class="d-block fw-bold text-secondary mt-1" id="dashInfo">-</small><small class="d-block text-muted text-truncate mt-1" id="dashKesan">...</small></div>
            <img src="https://via.placeholder.com/150" id="dashFoto" class="profile-img-lg shadow-sm">
        </div>
        <div class="card bg-primary text-white border-0 shadow-sm mb-3 rounded-4" style="background: linear-gradient(135deg, #0d6efd, #0056b3);"><div class="card-body py-3 d-flex justify-content-between align-items-center"><div><h5 class="fw-bold m-0">13 RUANG</h5><small class="opacity-75">Aktivitas & Layanan</small></div><i class="fas fa-school fa-2x opacity-50"></i></div></div>
        <div class="menu-grid" id="menuContainer"></div>
        <div class="d-grid gap-2 mb-4"><button type="button" onclick="confirmLogout()" class="btn btn-outline-danger py-3 rounded-4 fw-bold shadow-sm bg-white"><i class="fas fa-sign-out-alt me-2"></i> KELUAR APLIKASI</button></div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="d-flex align-items-center mb-4"><button class="btn btn-light btn-sm rounded-circle me-3" onclick="goBack()"><i class="fas fa-arrow-left"></i></button><h5 class="m-0 fw-bold">Edit Profil</h5></div>
        <form id="formEdit">
            <div class="text-center mb-3"><img src="" id="editFotoPreview" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid #ddd;"><div class="mt-3"><label class="btn btn-outline-primary btn-sm rounded-pill"><i class="fas fa-camera me-1"></i> Ganti Foto (Lokal)<input type="file" id="fileFoto" accept="image/*" style="display: none;" onchange="saveImageLocal(this)"></label></div></div>
            <div class="mb-2"><input type="text" class="form-control bg-light" id="editUsername" readonly></div>
            <div class="mb-2"><input type="text" class="form-control" id="editPass" placeholder="Password" required></div>
            <div class="mb-2"><input type="text" class="form-control bg-light" id="viewNama" readonly></div>
            <div class="row"><div class="col-6 mb-2"><select class="form-select" id="editJK"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div><div class="col-6 mb-2"><input type="text" class="form-control" id="editInfo"></div></div>
            <div class="mb-2"><input type="text" class="form-control" id="editAlamat" placeholder="Alamat"></div><div class="mb-2"><input type="number" class="form-control" id="editHP" placeholder="No HP"></div>
            <button type="submit" class="btn btn-success w-100 py-3 rounded-4 fw-bold mt-4 shadow">SIMPAN DATA</button>
        </form>
    </div>

    <div id="screen-generic" class="screen">
        <div class="d-flex align-items-center mb-3"><button class="btn btn-light btn-sm rounded-circle me-3" onclick="goBack()"><i class="fas fa-arrow-left"></i></button><h5 class="m-0 fw-bold" id="pageTitle">Judul</h5></div><div id="pageContent"></div>
    </div>

    <footer class="app-footer"><h6>RUANG BERSAMA</h6><small>Development by <strong>Muhammad Hasratul</strong></small></footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ===========================================
    // PASTE URL SCRIPT ANDA DI SINI
    // ===========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzbcXELSlu1SLwLOgNTBuUJj0u98NEQJjweb7yRO9Ja87vSjyAaIHVU4SXNxpBLi_s/exec"; 

    let currentUser = null;
    let currentChildUser = null;
    let currentChildName = null;

    document.getElementById('headerDate').innerText = new Date().toLocaleDateString('id-ID', {weekday:'long',year:'numeric',month:'long',day:'numeric'});

    function showPopup(t, m, i, cb) {
        document.getElementById('popup-title').innerText=t; document.getElementById('popup-msg').innerText=m; document.getElementById('popup-icon').innerHTML=`<i class="${i}"></i>`;
        const o=document.getElementById('custom-popup'); o.style.display='flex';
        const b=document.getElementById('popup-btn'); let nb=b.cloneNode(true); b.parentNode.replaceChild(nb,b);
        nb.onclick=function(){o.style.display='none'; if(cb)cb();};
    }
    function confirmLogout(){ showPopup("Sampai Jumpa!", "Terima kasih telah menggunakan Ruang Bersama.", "fas fa-hand-sparkles text-warning", function(){ currentUser=null; location.reload(); }); }
    function goBack() { showScreen('screen-dashboard'); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='screen-profile') loadProfileData(); }
    function setLoading(a) { document.getElementById('loader').style.display = a ? 'flex' : 'none'; }

    document.getElementById('formLogin').addEventListener('submit', function(e) {
        e.preventDefault(); setLoading(true);
        fetch(`${API_URL}?action=login&username=${document.getElementById('uName').value}&password=${document.getElementById('uPass').value}`)
        .then(r=>r.json()).then(res => { setLoading(false);
            if(res.status==='success') { currentUser=res.data; currentUser.role=res.role; showPopup("Selamat Datang!", `Halo, ${currentUser.nama}.`, "fas fa-smile-beam text-primary", function(){ initDashboard(); showScreen('screen-dashboard'); }); }
            else { alert(res.message); }
        });
    });

    function initDashboard() {
        document.getElementById('dashNama').innerText=currentUser.nama; document.getElementById('dashRole').innerText=currentUser.role; document.getElementById('dashInfo').innerText=currentUser.info||"-"; document.getElementById('dashKesan').innerText=currentUser.kesan||"";
        let lf=localStorage.getItem('img_'+currentUser.username); document.getElementById('dashFoto').src=lf||"https://via.placeholder.com/150";
        if(currentUser.role === 'Orangtua') {
            let savedChild = localStorage.getItem('child_user_' + currentUser.username);
            let savedChildName = localStorage.getItem('child_name_' + currentUser.username);
            if(savedChild && savedChildName) { currentChildUser = savedChild; currentChildName = savedChildName; document.getElementById('dashInfo').innerHTML = `<i class="fas fa-child text-primary"></i> ${savedChildName}`; } 
            else { document.getElementById('dashInfo').innerHTML = `<i class="fas fa-exclamation-circle text-danger"></i> Belum pilih anak`; }
        }
        const menus=[
            {n:"Ruang Ide", i:"fa-lightbulb", c:"#ffc107", f:openIde}, {n:"Ruang Rasa", i:"fa-heart", c:"#dc3545", f:openRasa}, {n:"Aspirasi", i:"fa-star", c:"#28a745", f:openAspirasi}, {n:"Evaluasi", i:"fa-exclamation-triangle", c:"#fd7e14", f:openEvaluasi},
            {n:"Orangtua", i:"fa-user-friends", c:"#0dcaf0", f:openOrtu}, {n:"Konseling", i:"fa-comments", c:"#6f42c1", f:openKonseling}, {n:"Ruang Chat", i:"fa-comment-dots", c:"#20c997", f:openChat}, {n:"Mood & Kesan", i:"fa-smile", c:"#e83e8c", f:openMood},
            {n:"Ruang Baca", i:"fa-book-open", c:"#6610f2", f:()=>openPublicList('baca','Ruang Baca','fa-book')}, {n:"Ruang Data", i:"fa-database", c:"#adb5bd", f:()=>openPublicList('data','Ruang Data','fa-database')}, {n:"Prestasi", i:"fa-trophy", c:"#ffc107", f:()=>openPublicList('prestasi','Ruang Prestasi','fa-trophy')}, {n:"Pengumuman", i:"fa-bullhorn", c:"#0d6efd", f:()=>openPublicList('pengumuman','Pengumuman','fa-bullhorn')},
            {n:"Diskusi", i:"fa-users", c:"#fd7e14", f:openDiskusi}, {n:"Pengaturan", i:"fa-cog", c:"#343a40", f:()=>showScreen('screen-profile')}, {n:"Pengembang", i:"fa-code", c:"#000000", f:openPengembang}
        ];
        let h=""; menus.forEach((m,i)=>h+=`<div class="menu-item" onclick="window.menus[${i}].f()"><i class="fas ${m.i}" style="color:${m.c}"></i><span>${m.n}</span></div>`);
        document.getElementById('menuContainer').innerHTML=h; window.menus=menus;
    }

    // --- ORTU & ANAK ---
    function openOrtu() {
        let isOrtu = currentUser.role === 'Orangtua'; let form = '';
        if(isOrtu) {
            if(currentChildUser) { form = `<div class="p-3 bg-light rounded mb-3"><div class="d-flex justify-content-between align-items-center mb-3"><div class="small fw-bold text-success"><i class="fas fa-check-circle"></i> Terhubung: ${currentChildName}</div><button class="btn btn-sm btn-outline-danger" onclick="resetChild()">Ganti Anak</button></div><h6 class="fw-bold">Info ke Guru</h6><input type="date" id="oTgl" class="form-control mb-2"><select id="oTuj" class="form-select mb-2"></select><input type="text" id="oJdl" class="form-control mb-2" placeholder="Judul Info"><textarea id="oDesk" class="form-control mb-2" rows="2" placeholder="Deskripsi..."></textarea><button class="btn btn-info w-100 text-white fw-bold" onclick="krmOrtu()">KIRIM INFO</button></div>`; } 
            else { form = `<div class="p-3 bg-light rounded mb-3"><h6 class="fw-bold mb-2">Verifikasi Data Anak</h6><p class="small text-muted mb-3">Pilih nama anak dan masukkan password akun siswa mereka.</p><select id="pilihAnak" class="form-select mb-3" onchange="verifyChild(this)"><option value="">-- Pilih Nama Anak --</option></select></div>`; }
        }
        renderPage("Ruang Orangtua", `${form}<div id="list-ortu">Loading...</div>`);
        if (isOrtu) { if(!currentChildUser) loadSiswaForParent(); else loadGuruList('oTuj'); }
        loadCard('get_info_ortu', 'list-ortu', 'border-info', currentChildUser);
    }
    function loadSiswaForParent() { fetch(API_URL + "?action=get_siswa_data").then(r=>r.json()).then(res => { let opts = '<option value="">-- Pilih Nama Anak --</option>'; res.data.forEach(s => { opts += `<option value="${s.username}">${s.nama}</option>`; }); if(document.getElementById('pilihAnak')) document.getElementById('pilihAnak').innerHTML = opts; }); }
    function verifyChild(el) {
        let u=el.value, n=el.options[el.selectedIndex].text; if(!u)return;
        let p=prompt(`Masukkan Password Akun Siswa "${n}":`); if(!p){el.value="";return;}
        setLoading(true);
        fetch(`${API_URL}?action=verify_child&child_username=${u}&child_password=${p}`).then(r=>r.json()).then(res => { setLoading(false); if(res.status==='success') { alert("Berhasil Terhubung!"); currentChildUser=u; currentChildName=n; localStorage.setItem('child_user_'+currentUser.username, u); localStorage.setItem('child_name_'+currentUser.username, n); initDashboard(); openOrtu(); } else { alert("Password Salah!"); el.value=""; } });
    }
    function resetChild() { if(confirm("Ganti Anak?")) { localStorage.removeItem('child_user_'+currentUser.username); localStorage.removeItem('child_name_'+currentUser.username); currentChildUser=null; currentChildName=null; initDashboard(); openOrtu(); } }
    function krmOrtu(){ if(!currentChildUser) return; submitGeneral("simpan_info_ortu", {username_anak:currentChildUser, tanggal:getVal('oTgl'), judul:getVal('oJdl'), deskripsi:getVal('oDesk'), tujuan:getVal('oTuj')}, ()=>loadCard('get_info_ortu','list-ortu','border-info', currentChildUser)); }

    // --- INTEGRASI ASPIRASI & EVALUASI ---
    function openAspirasi() { openAspEval('Aspirasi', 'simpan_aspirasi', 'get_aspirasi', 'success'); }
    function openEvaluasi() { openAspEval('Evaluasi', 'simpan_evaluasi', 'get_evaluasi', 'danger'); }
    function openAspEval(n, s, g, c) {
        let isGuru=currentUser.role==='Guru';
        if(currentUser.role==='Orangtua' && !currentChildUser) { alert("Silakan hubungkan akun anak di menu 'Ruang Orangtua' terlebih dahulu."); return; }
        let form=isGuru?`<div class="p-3 bg-light rounded mb-3"><h6 class="fw-bold">Input ${n}</h6><input type="date" id="aTgl" class="form-control mb-2"><select id="aSis" class="form-select mb-2"></select><input type="text" id="aJdl" class="form-control mb-2" placeholder="${n=='Aspirasi'?'Karakter':'Perihal'}"><textarea id="aDesk" class="form-control mb-2" rows="2"></textarea>${n=='Aspirasi'?'<div class="form-check mb-2"><input type="checkbox" id="aPub" class="form-check-input" checked><label class="small">Publik</label></div>':''}<button class="btn btn-${c} w-100" onclick="krmAspEval('${s}','${n}')">SIMPAN</button></div>`:'';
        let hInfo=(currentUser.role==='Orangtua')?`<div class="alert alert-${c} small py-2 mb-2"><i class="fas fa-user-graduate"></i> Data untuk: <strong>${currentChildName}</strong></div>`:'';
        renderPage(`Ruang ${n}`, `${hInfo}${form}<div id="list-aspeval">Loading...</div>`);
        if(isGuru) loadSiswaList('aSis'); loadCard(g, 'list-aspeval', `border-${c}`, null, currentChildName);
    }
    function krmAspEval(act, n) { let d={nama_guru:currentUser.nama, nama_siswa:getVal('aSis'), tanggal:getVal('aTgl'), deskripsi:getVal('aDesk')}; if(n=='Aspirasi'){d.karakter=getVal('aJdl'); d.publik=document.getElementById('aPub').checked?"Ya":"Tidak";} else {d.perihal=getVal('aJdl');} submitGeneral(act, d, ()=>loadCard(n=='Aspirasi'?'get_aspirasi':'get_evaluasi', 'list-aspeval', n=='Aspirasi'?'border-success':'border-danger')); }

    // --- FUNGSI UTILS ---
    function getVal(id){return document.getElementById(id).value;}
    function submitGeneral(act, data, cb){ setLoading(true); data.action=act; data.username=currentUser.username; data.role=currentUser.role; data.nama=currentUser.nama; const p=new URLSearchParams(data); fetch(API_URL+"?"+p).then(r=>r.json()).then(res=>{setLoading(false);alert(res.message);if(cb)cb();}); }
    function loadGuruList(id) { fetch(API_URL+"?action=get_list_guru").then(r=>r.json()).then(d=>{let o='<option>Pilih Guru...</option>';d.data.forEach(g=>o+=`<option>${g}</option>`);document.getElementById(id).innerHTML=o;}); }
    function loadSiswaList(id) { fetch(API_URL+"?action=get_list_siswa").then(r=>r.json()).then(d=>{let o='<option value="">Pilih Siswa...</option>';d.data.forEach(s=>o+=`<option>${s}</option>`);document.getElementById(id).innerHTML=o;}); }
    function loadCard(a,el,c, filterU, filterN) { document.getElementById(el).innerHTML='Loading...'; let p={action:a, role:currentUser.role, nama:currentUser.nama, info:currentUser.info, username:currentUser.username}; if(filterU) p.username_anak=filterU; if(filterN) p.nama_anak=filterN; fetch(API_URL+"?"+new URLSearchParams(p)).then(r=>r.json()).then(res=>{let h=res.data.length?'':'<div class="text-center text-muted mt-3">Kosong.</div>';res.data.forEach(d=>{h+=`<div class="card ${c} mb-2 p-3 shadow-sm rounded-4"><strong>${d.pengirim||d.anak||d.siswa}</strong><small>${d.judul}</small><p class="small text-muted m-0">${d.deskripsi}</p></div>`});document.getElementById(el).innerHTML=h;}); }
    
    // --- FITUR LAIN ---
    function openIde() { let isGuru=currentUser.role==='Guru'; let form=isGuru?'':`<div class="p-3 bg-light rounded mb-3"><h6 class="fw-bold">Tulis Ide</h6><input type="date" id="iTgl" class="form-control mb-2"><input type="text" id="iJdl" class="form-control mb-2" placeholder="Judul"><textarea id="iDesk" class="form-control mb-2" rows="3" placeholder="Isi ide..."></textarea><button class="btn btn-warning w-100 fw-bold" onclick="kirimIde()">KIRIM</button></div>`; renderPage("Ruang Ide", `${form}<div id="list-ide">Loading...</div>`); loadIde(); }
    function kirimIde(){ submitGeneral("simpan_ide", {tanggal:getVal('iTgl'), judul:getVal('iJdl'), deskripsi:getVal('iDesk')}, loadIde); }
    function loadIde(){ fetch(API_URL+`?action=get_ide&username=${currentUser.username}&role=${currentUser.role}`).then(r=>r.json()).then(res=>{ let h=''; res.data.forEach(d=>{ let replyHtml = d.balasan!=='-' ? `<div class="mt-2 p-2 bg-warning-subtle rounded border border-warning small"><strong>Balasan Guru:</strong> ${d.balasan}</div>` : (currentUser.role==='Guru'?`<div class="input-group mt-2"><input type="text" class="form-control form-control-sm" id="rep_${d.id}" placeholder="Balas..."><button class="btn btn-sm btn-primary" onclick="replyIde('${d.id}')">Kirim</button></div>`:'<small class="text-muted d-block mt-2">Menunggu balasan...</small>'); let delBtn = (currentUser.username===d.nama || currentUser.role === d.role) ? `<i class="fas fa-trash text-danger float-end" onclick="hapusIde('${d.id}')"></i>` : ''; h+=`<div class="card card-custom p-3 mb-2 border-start border-4 border-warning"><div><small class="fw-bold text-warning">${d.nama} (${d.role})</small>${delBtn}</div><h6 class="fw-bold mt-1">${d.judul}</h6><p class="small text-muted mb-1">${d.deskripsi}</p>${replyHtml}</div>`; }); document.getElementById('list-ide').innerHTML=h||'<p class="text-center text-muted">Belum ada data.</p>'; }); }
    function replyIde(id){ let val=document.getElementById('rep_'+id).value; if(!val)return; fetch(`${API_URL}?action=respon_ide&id_post=${id}&balasan=${val}`).then(r=>r.json()).then(d=>{alert(d.message);loadIde();}); }
    function hapusIde(id){ if(confirm("Hapus?")) fetch(`${API_URL}?action=hapus_ide&id_post=${id}&username=${currentUser.username}`).then(r=>r.json()).then(d=>{alert(d.message);loadIde();}); }
    function openRasa() { if(currentUser.role==='Orangtua'){alert("Maaf, Ruang Rasa khusus Siswa."); return;} let isGuru=currentUser.role==='Guru'; let form=isGuru?'':`<div class="p-3 bg-light rounded mb-3"><h6 class="fw-bold">Curhat Yuk</h6><input type="date" id="rTgl" class="form-control mb-2"><select id="rTuj" class="form-select mb-2"></select><input type="text" id="rJdl" class="form-control mb-2" placeholder="Judul"><textarea id="rDesk" class="form-control mb-2" rows="3" placeholder="Cerita..."></textarea><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="rAnon"><label class="small">Anonim</label></div><button class="btn btn-danger w-100 fw-bold" onclick="kirimRasa()">KIRIM</button></div>`; renderPage("Ruang Rasa", `${form}<div id="list-rasa">Loading...</div>`); if(!isGuru) loadGuruList('rTuj'); loadRasa(); }
    function kirimRasa(){ submitGeneral("simpan_rasa", {tanggal:getVal('rTgl'), tujuan:getVal('rTuj'), judul:getVal('rJdl'), deskripsi:getVal('rDesk'), anonim:document.getElementById('rAnon').checked}, loadRasa); }
    function loadRasa(){ fetch(API_URL+`?action=get_rasa&username=${currentUser.username}&role=${currentUser.role}`).then(r=>r.json()).then(res=>{ let h=''; res.data.forEach(d=>{ let nm=d.anonim==='Ya'?'Seseorang':d.nama; let replyHtml=d.balasan!=='-' ? `<div class="mt-2 p-2 bg-danger-subtle rounded border border-danger small"><strong>Guru:</strong> ${d.balasan}</div>` : (currentUser.role==='Guru'?`<div class="input-group mt-2"><input type="text" class="form-control form-control-sm" id="repr_${d.id}" placeholder="Respon..."><button class="btn btn-sm btn-primary" onclick="replyRasa('${d.id}')">Kirim</button></div>`:'<small class="text-muted">Menunggu respon...</small>'); let delBtn=(d.nama===currentUser.username)?`<i class="fas fa-trash text-secondary float-end" onclick="hapusRasa('${d.id}')"></i>`:''; h+=`<div class="card card-custom p-3 mb-2 border-start border-4 border-danger"><div><small class="fw-bold text-danger">${nm}</small> <small class="text-muted">to ${d.tujuan}</small>${delBtn}</div><h6 class="fw-bold mt-1">${d.judul}</h6><p class="small text-muted mb-1">${d.deskripsi}</p>${replyHtml}</div>`; }); document.getElementById('list-rasa').innerHTML=h||'<p class="text-center text-muted">Belum ada curhat.</p>'; }); }
    function replyRasa(id){ let val=document.getElementById('repr_'+id).value; if(!val)return; fetch(`${API_URL}?action=respon_rasa&id_post=${id}&balasan=${val}`).then(r=>r.json()).then(d=>{alert(d.message);loadRasa();}); }
    function hapusRasa(id){ if(confirm("Hapus?")) fetch(`${API_URL}?action=hapus_rasa&id_post=${id}&username=${currentUser.username}`).then(r=>r.json()).then(d=>{alert(d.message);loadRasa();}); }
    function openKonseling() { let isGuru=currentUser.role==='Guru'; let form=isGuru?'':`<div class="p-3 bg-light rounded mb-3"><h6 class="fw-bold">Buat Janji BK</h6><select id="kTuj" class="form-select mb-2"></select><input type="text" id="kWkt" class="form-control mb-2" placeholder="Hari, Tgl, Jam"><textarea id="kPerlu" class="form-control mb-2" rows="2" placeholder="Keperluan"></textarea><button class="btn btn-primary w-100" onclick="krmKonsel()">AJUKAN</button></div>`; renderPage("Ruang Konseling", `${form}<div id="list-konsel">Loading...</div>`); if(!isGuru) loadGuruList('kTuj'); loadKonsel(); }
    function krmKonsel(){ submitGeneral("simpan_konseling", {tujuan_guru:getVal('kTuj'), tanggal_jam:getVal('kWkt'), keperluan:getVal('kPerlu')}, loadKonsel); }
    function loadKonsel(){ fetch(API_URL+`?action=get_konseling&username=${currentUser.username}&role=${currentUser.role}&nama=${currentUser.nama}`).then(r=>r.json()).then(res=>{ let h=''; res.data.forEach(d=>{ let badge=d.status==='Menunggu'?'bg-warning':(d.status==='Diterima'?'bg-success':'bg-danger'); let action=currentUser.role==='Guru' && d.status==='Menunggu' ? `<div class="mt-2"><button class="btn btn-sm btn-success me-1" onclick="respKonsel('${d.id}','Diterima')">Terima</button><button class="btn btn-sm btn-danger" onclick="respKonsel('${d.id}','Ditolak')">Tolak</button></div>` : `<small class="d-block mt-1 text-muted">Info: ${d.balasan}</small>`; h+=`<div class="card card-custom p-3 mb-2 border-start border-4 border-primary"><div class="d-flex justify-content-between"><strong>${d.pemohon} -> ${d.guru}</strong><span class="badge ${badge}">${d.status}</span></div><small>${d.waktu}</small><p class="small m-0">${d.keperluan}</p>${action}</div>`; }); document.getElementById('list-konsel').innerHTML=h||'<p class="text-center text-muted">Belum ada janji.</p>'; }); }
    function respKonsel(id, st){ let msg=prompt("Pesan tambahan (Lokasi/Info):", "Silakan datang ke ruang BK"); if(!msg)return; fetch(`${API_URL}?action=respon_konseling&id_post=${id}&status=${st}&balasan=${msg}`).then(r=>r.json()).then(d=>{alert(d.message);loadKonsel();}); }
    function openChat() { renderPage("Ruang Chat", `<div id="chat-contact-view"><p class="small text-muted mb-2">Pilih kontak:</p><div id="chat-contacts" class="list-group">Loading...</div></div><div id="chat-room-view" style="display:none;"><div class="d-flex align-items-center mb-3 p-2 bg-light rounded"><button class="btn btn-sm btn-secondary me-2" onclick="closeChatRoom()"><i class="fas fa-times"></i></button><strong id="chat-partner-name">Nama</strong></div><div id="chat-messages" style="height:300px;overflow-y:auto;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;mb-2"></div><div class="input-group mt-2"><input type="text" class="form-control" id="chat-input" placeholder="Tulis..."><button class="btn btn-primary" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button></div></div>`); fetch(`${API_URL}?action=get_chat_contacts&role=${currentUser.role}`).then(r=>r.json()).then(res=>{let h='';res.data.forEach(c=>h+=`<button class="list-group-item list-group-item-action" onclick="openChatRoom('${c}')"><i class="fas fa-user-circle me-2"></i> ${c}</button>`);document.getElementById('chat-contacts').innerHTML=h;}); }
    let chatPartner=''; function openChatRoom(n){chatPartner=n;document.getElementById('chat-contact-view').style.display='none';document.getElementById('chat-room-view').style.display='block';document.getElementById('chat-partner-name').innerText=n;loadMessages();} function closeChatRoom(){document.getElementById('chat-contact-view').style.display='block';document.getElementById('chat-room-view').style.display='none';} function loadMessages(){document.getElementById('chat-messages').innerHTML='<small>Loading...</small>';fetch(`${API_URL}?action=get_chat&user1=${currentUser.nama}&user2=${chatPartner}`).then(r=>r.json()).then(res=>{let h='';res.data.forEach(m=>{let c=m.sender===currentUser.nama?'chat-me':'chat-other';h+=`<div class="d-flex flex-column"><div class="chat-bubble ${c}">${m.message}</div></div>`;});document.getElementById('chat-messages').innerHTML=h;});} function sendChat(){let m=document.getElementById('chat-input').value;if(!m)return;fetch(`${API_URL}?action=simpan_chat&sender=${currentUser.nama}&receiver=${chatPartner}&message=${m}`).then(()=>{document.getElementById('chat-input').value='';loadMessages();});}
    function openMood() { renderPage("Mood & Kesan", `<div class="text-center mb-4"><p class="small text-muted">Bagaimana perasaanmu?</p><div class="d-flex justify-content-center gap-3 mb-3"><i class="mood-icon fas fa-laugh-beam text-success" onclick="selMood(this,'Senang')"></i><i class="mood-icon fas fa-meh text-warning" onclick="selMood(this,'Biasa')"></i><i class="mood-icon fas fa-frown text-danger" onclick="selMood(this,'Sedih')"></i><i class="mood-icon fas fa-tired text-secondary" onclick="selMood(this,'Lelah')"></i></div><input type="hidden" id="f_mood"><input type="text" class="form-control mb-3 text-center" id="f_kesan" placeholder="Tulis kesan singkat..." required><button class="btn btn-primary w-100 rounded-pill" onclick="submitMood()">UPDATE STATUS</button></div><hr>${currentUser.role==='Guru'?'<h6 class="fw-bold small">Mood Siswa</h6><div id="list-mood-guru"></div>':''}`); if(currentUser.role==='Guru') loadMoodGuru(); }
    function selMood(e,v){document.querySelectorAll('.mood-icon').forEach(x=>x.classList.remove('mood-selected'));e.classList.add('mood-selected');document.getElementById('f_mood').value=v;} function submitMood(){let m=document.getElementById('f_mood').value,k=document.getElementById('f_kesan').value;if(!m||!k){alert("Pilih mood dan tulis kesan.");return;}setLoading(true);fetch(`${API_URL}?action=simpan_mood&username=${currentUser.username}&nama=${currentUser.nama}&mood=${m}&kesan=${k}`).then(r=>r.json()).then(res=>{setLoading(false);alert(res.message);currentUser.kesan=k;initDashboard();goBack();});} function loadMoodGuru(){fetch(`${API_URL}?action=get_mood_guru`).then(r=>r.json()).then(res=>{let h='';res.data.forEach(d=>h+=`<div class="d-flex justify-content-between border-bottom py-2"><small>${d.nama}</small><span class="badge bg-light text-dark">${d.mood} - ${d.kesan}</span></div>`);document.getElementById('list-mood-guru').innerHTML=h;});}
    function openPublicList(t,n,i) { renderPage(n, `<div id="list-public">Loading...</div>`); fetch(`${API_URL}?action=get_public_data&type=${t}`).then(r=>r.json()).then(res=>{let h=res.data.length?'':'<div class="text-center text-muted mt-5">Kosong.</div>';res.data.forEach(d=>{h+=`<div class="card card-custom p-3"><div class="d-flex align-items-center mb-2"><i class="fas ${i} fa-lg me-3 text-secondary"></i><h6 class="fw-bold m-0">${d.col1}</h6></div><p class="small text-muted">${d.col2}</p><small class="text-primary">${d.col3.includes('http')?`<a href="${d.col3}" target="_blank">Buka Link</a>`:d.col3}</small></div>`});document.getElementById('list-public').innerHTML=h;}); }
    function openDiskusi() { renderPage("Ruang Diskusi", `<div class="mb-3"><textarea class="form-control mb-2" id="diskusi-konten" rows="2" placeholder="Apa yang Anda pikirkan?"></textarea><button class="btn btn-primary btn-sm w-100" onclick="postDiskusi()">POSTING</button></div><div id="list-diskusi"></div>`); loadDiskusi(); }
    function postDiskusi(){let c=document.getElementById('diskusi-konten').value;if(!c)return;setLoading(true);fetch(`${API_URL}?action=simpan_diskusi&nama=${currentUser.nama}&role=${currentUser.role}&konten=${c}`).then(r=>r.json()).then(res=>{setLoading(false);document.getElementById('diskusi-konten').value='';loadDiskusi();});} function loadDiskusi(){document.getElementById('list-diskusi').innerHTML='Loading...';fetch(`${API_URL}?action=get_diskusi`).then(r=>r.json()).then(res=>{let h='';res.data.forEach(d=>{let del=d.nama===currentUser.nama?`<button class="btn btn-link text-danger btn-sm p-0 ms-2" onclick="hapusDiskusi('${d.id}')">Hapus</button>`:'';h+=`<div class="card card-custom p-3 mb-2"><div class="d-flex justify-content-between"><small class="fw-bold text-primary">${d.nama}</small><small class="text-muted" style="font-size:10px;">${d.waktu.substring(0,10)}</small></div><p class="mb-2 mt-1 small">${d.konten}</p><div class="d-flex align-items-center"><i class="far fa-heart text-danger me-1"></i> <small>${d.likes}</small> ${del}</div></div>`});document.getElementById('list-diskusi').innerHTML=h;});} function hapusDiskusi(id){if(!confirm("Hapus?"))return;fetch(`${API_URL}?action=hapus_diskusi&id_post=${id}&nama=${currentUser.nama}`).then(r=>r.json()).then(res=>{alert(res.message);loadDiskusi();});}
    function renderPage(title, content) { document.getElementById('pageTitle').innerText = title; document.getElementById('pageContent').innerHTML = content; showScreen('screen-generic'); }
    function loadProfileData() { document.getElementById('editUsername').value=currentUser.username; document.getElementById('editPass').value=currentUser.password; document.getElementById('viewNama').value=currentUser.nama; document.getElementById('editJK').value=currentUser.jk; document.getElementById('editInfo').value=currentUser.info; document.getElementById('editAlamat').value=currentUser.alamat; document.getElementById('editHP').value=currentUser.hp; document.getElementById('editFotoPreview').src=localStorage.getItem('img_'+currentUser.username)||"https://via.placeholder.com/150"; }
    function saveImageLocal(input) { if (input.files && input.files[0]) { let file = input.files[0]; var reader = new FileReader(); reader.onload = function (e) { try { localStorage.setItem('img_' + currentUser.username, e.target.result); document.getElementById('editFotoPreview').src = e.target.result; alert("Foto tersimpan di HP ini!"); } catch (err) { alert("Memori Penuh/Gagal Simpan"); } }; reader.readAsDataURL(file); } }
    document.getElementById('formEdit').addEventListener('submit', function(e){ e.preventDefault(); setLoading(true); const p = new URLSearchParams({ action: "update", old_username: currentUser.username, new_username: document.getElementById('editUsername').value, password: document.getElementById('editPass').value, jk: document.getElementById('editJK').value, info: document.getElementById('editInfo').value, alamat: document.getElementById('editAlamat').value, hp: document.getElementById('editHP').value }); fetch(API_URL+"?"+p).then(r=>r.json()).then(res => { setLoading(false); if(res.status==='success') { currentUser.password = document.getElementById('editPass').value; currentUser.jk = document.getElementById('editJK').value; currentUser.info = document.getElementById('editInfo').value; currentUser.alamat = document.getElementById('editAlamat').value; currentUser.hp = document.getElementById('editHP').value; alert("Data Profil Tersimpan!"); initDashboard(); goBack(); } else { alert(res.message); } }).catch(err => { setLoading(false); alert("Error"); }); });
    function openPengembang() { let devPhoto = "https://lh3.googleusercontent.com/d/19RBb-asjqwYsSUzDd0ve7Y8dgimQ2W2m"; renderPage("Pengembang", `<div class="dev-card"><img src="${devPhoto}" class="dev-img"><h5 class="fw-bold mb-1">Muhammad Hasratul, S.Pd.,Gr.,M.M</h5><p class="small opacity-75 mb-3">Guru Bimbingan dan Konseling</p><div class="bg-white text-dark rounded-3 p-3 text-start shadow-sm mx-auto" style="max-width:300px;"><div class="mb-2"><small class="text-muted d-block">Asal</small><strong>Makassar</strong></div><div class="mb-0"><small class="text-muted d-block">Instansi</small><strong>UPT SPF SMP Negeri 16 Makassar</strong></div></div><div class="mt-4 small opacity-50">Â© 2026 Ruang Bersama</div></div>`); }
</script>

</body>
</html>
